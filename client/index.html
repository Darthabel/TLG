<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Long Git</title>
    <script type="text/javascript" src="js/d3.v3.min.js"></script>
    <script>
      function get_query_string(search_field_id){
        var search_field = document.getElementById(search_field_id);
        return "q=" + search_field.value.trim().replace(/\s+/g,"+");
      }

      function update_hash(hash_string){
        window.location.hash = hash_string;
      }

      function call_search_api(){
        var query_string = get_query_string("search_field")
        update_hash("/" + query_string);
        d3.json(
          "http://localhost:5000/search?" + query_string,
          function(error,data){
            if (data === undefined){
              alert("Error: the search request did not work, please try again");
            } else {
              display_results(data);
            }
          }
        );
      }

      function call_repo_api(url){
        d3.json(
          "http://localhost:5000/repository?url=" + url,
//          url + "commits?per_page=100",
          function(error,data){
            if (data === undefined){
              alert("Error: the repository request did not work, please try again");
            } else {
              console.log(data);
            }
          }
        );
      }

      function display_results(json){
        var tmp_result_div;
        var result_array = [];

        var items = json.items;
        items.forEach(function(element, index, array){
          result_array.push(format_search_result(element));
        });

        var results_div = document.getElementById('search_results');
        results_div.textContent = "";
        append_children(results_div, result_array);
      }

      function format_search_result(element){
        var result_div = document.createElement('div');
        result_div.className = 'result';
        result_div.textContent = element.full_name;
        result_div.onclick = function(){call_repo_api(element.url + "/")};

        return result_div
      }
      
      function append_children(parent, children){
        var fragment = document.createDocumentFragment();
        children.forEach(function(element, index, array){
          fragment.appendChild(element);
        });

        parent.appendChild(fragment);
      
      }
    </script>
  </head>
  <body>
    <label for="search_field">The Long Git search :</label>
    <input type="search" name="search_field" id="search_field"/>
    <button onclick="call_search_api()">GO!</button>
    <div id="search_results">Here shall be results!</div>
  </body>
</html>
